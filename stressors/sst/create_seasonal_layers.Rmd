---
title: "Creating Seasonal SST layers for the BSR"
author: "Jamie Afflerbach"
date: "11/9/2015"
output: html_document
---

```{r}
knitr::opts_chunk$set(fig.path='Figs/', warning=FALSE, message=FALSE)
```

```{r setup}
 source('../../common.R')

```


Raw data was copied from neptune to aurora to access weekly ssta data.

```{r data}

# Bring in SSTA data

ssta         = stack(file.path(dir_arctic,'stressors/sst/raw/cortadv5_SSTA.nc'),varname='SSTA')
weekly_sst   = stack(file.path(dir_arctic,'stressors/sst/raw/cortadv5_WeeklySST.nc'),varname='WeeklySST')

names_ssta   = names(ssta) 
names_weekly = names(weekly_sst)
```

The ice-season is from November to May. Since this data is provided weekly we can create two layers, one for each season.

```{r weekly stand dev, eval=F}

#ICE SEASON

#Create weekly standard deviations across all years

#Select all weeks in november-may

ice_data = ssta[[which(substr(names_ssta,7,8)%in% c("01","02","03","04","05","11","12"))]]
icefree_data = ssta[[which(substr(names_ssta,7,8)%in% c("06","07","08","09","10"))]] 
```

The global mean standard deviation for each week across all years is already calculated from this dataset. Just need to calculate difference from the SD for each week in each annual season...

Second Loop to calculate annual positive anomalies

```{r ice season,echo=F,eval=F}

for (i in 1982:2009){
  
  print(i)
  
  s = stack() #set empty stack
  
    a = ice_data[[which(substr(names(ice_data),2,5)==i)]] #grab all locations of files where year matches year and put them all in a raster stack

    a_data = a[[which(substr(names(a),7,8)%in% c("11","12"))]] #then grab only the last months of that year
    
    #grab all weeks in the following year for january through may and create a stack
    b = ice_data[[which(substr(names(ice_data),2,5)==i+1)]] 
    
    b_data = b[[which(substr(names(b),7,8) %in% c("01","02","03","04","05"))]]
    
    season = stack(a_data,b_data)
    
    
    for (j in 1:nlayers(season)){
      
      print(j)
        
      # To find out which week in the year, and therefore what weekly SD to compare against, 
        #the following grabs all weeks in the year then asks what week in that year is equal to the week we are looking at
  
          r = season[[j]]
      
          name = names(season)[j]
      
          all     = which(substr(names(weekly_sst),2,5)==substr(name,2,5))
          w       = weekly_sst[[all]]
          week_no = which(names(w)==name)
          
          sd = raster(paste0(file.path(dir_arctic,'stressors/sst/working/sd_sst_week_'),week_no,'.tif')) #sd for week
          
          count = overlay(r,sd,fun=function(x,y){ifelse(x>y,1,0)},progress='text') #compare to average anomaly for that week 
    
          
    s = stack(s,count)
      
      
    }
    
    year = calc(s,fun=function(x){sum(x,na.rm=T)},progress='text',
                filename=paste0(file.path(dir_arctic),'/stressors/sst/working/seasonal_pos_anomalies_sd_','ice','_',i,'-',i+1,'.tif'),
                overwrite=T)
    
  }

```

```{r ice free,eval=F,echo=F}

for (i in 1982:2012){
  
  print(i)
  
  s = stack() #set empty stack
  
    season = icefree_data[[which(substr(names(icefree_data),2,5)==i)]] #grab all locations of files where year matches year 
    
    for (j in 1:nlayers(season)){
      
      print(j)
        
      # To find out which week in the year, and therefore what weekly SD to compare against, 
        #the following grabs all weeks in the year then asks what week in that year is equal to the week we are looking at
  
          r = season[[j]]
      
          name = names(season)[j]
      
          all     = which(substr(names(weekly_sst),2,5)==substr(name,2,5))
          w       = weekly_sst[[all]]
          week_no = which(names(w)==name)
          
          sd = raster(paste0(file.path(dir_arctic,'stressors/sst/working/sd_sst_week_'),week_no,'.tif')) #sd for week
          
          count = overlay(r,sd,fun=function(x,y){ifelse(x>y,1,0)},progress='text') #compare to average anomaly for that week 
    
          
    s = stack(s,count)
      
      
    }
    
    year = calc(s,fun=function(x){sum(x,na.rm=T)},progress='text',
                filename=paste0(file.path(dir_arctic),'/stressors/sst/working/seasonal_pos_anomalies_sd_','icefree','_',i,'.tif'),
                overwrite=T)
    
  }

```

```{r,echo=F}

l_icefree   <- list.files(file.path(dir_arctic,'stressors/sst/working'),pattern='icefree',full.names=TRUE)

l <- list.files(file.path(dir_arctic,'stressors/sst/working'),pattern='ice',full.names=T)

l_ice <- setdiff(l,l_icefree)
```

Get 5 year aggregates
```{r,echo=F}

sst_change <- function(list,season){

yrs_1982_1986 <- stack(list[1:5])%>%sum(.) # This is the time period we are using for historical comparison

#define arctic projection
laeaCRS <- CRS("+init=epsg:3572")

#calculate
  
  s <- stack(list[(length(list)-4):length(list)])%>%sum(.)
  
  diff = s - yrs_1982_1986
  
  projection(diff) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

  out_pan = crop(diff,extent(-180,180,50,90),progress='text')%>%
             projectRaster(.,crs=laeaCRS,progress='text')%>%
              mask(.,pan,progress='text')%>%
              resample(.,pan_ocean,method='ngb',progress='text',
                    filename=paste0(file.path(dir_arctic),'/stressors/sst/output/pan_sst_',season,2008,'_',2012,'-1982_1986.tif',sep=""),overwrite=T)
  

  out_bsr = mask(out_pan,bsr,progress='text')%>%
              crop(.,bsr,
                 filename=paste0(file.path(dir_arctic),'/stressors/sst/output/bsr_sst_',season,2008,'_',2012,'-1982_1986.tif',sep=""),overwrite=T)
  
  return(out_bsr)
}

sst_change(l_icefree,'icefree')
sst_change(l_ice,'ice')

ice = raster(file.path(dir_arctic,'stressors/sst/output/pan_sst_ice2008_2012-1982_1986.tif'))
             
plot(ice,col=cols,box=F,axes=F,main='SST Anomalies across the Pan-Arctic \n Ice Season')

histogram(ice, main = 'Ice')
     
icefree = raster(file.path(dir_arctic,'stressors/sst/output/pan_sst_icefree2008_2012-1982_1986.tif'))

plot(icefree,col=cols,box=F,axes=F,main='SST Anomalies across the Pan-Arctic \n Icefree Season')

histogram(icefree,main='Icefree')

```

Rescale to maximum across the pan-arctic across the year. Here we are NOT rescaling within season, using the maximum whether it came from winter or summer.

```{r rescale, echo=F}

#bring in the pan-arctic ice and ice free rasters

pan_r = stack(file.path(dir_arctic,'stressors/sst/output/pan_sst_ice2008_2012-1982_1986.tif'), file.path(dir_arctic,'stressors/sst/output/pan_sst_icefree2008_2012-1982_1986.tif'))

max_pan = max(cellStats(pan_r,stat='max'))

pan_ice = raster(file.path(dir_arctic,'stressors/sst/output/pan_sst_ice2008_2012-1982_1986.tif'))

pan_rescale = calc(pan_ice,fun=function(x){ifelse(x>0,x/max_pan,0)},progress='text',
                   filename=paste0(file.path(dir_arctic),'/stressors/sst/output/pan_sst_ice_rescaled.tif',sep=""),overwrite=T)

bsr_rescale = crop(pan_rescale,bsr)%>%
                mask(.,bsr,add=T,filename='../seasonal_output/bsr_sst_ice_rescaled.tif',overwrite=T)

plot(bsr_rescale,col=cols,box=F,axes=F,main='Bering Strait SST \nIce Season')

#ice free

pan_icefree = raster(file.path(dir_arctic,'stressors/sst/output/pan_sst_icefree2008_2012-1982_1986.tif'))

pan_rescale = calc(pan_icefree,fun=function(x){ifelse(x>0,x/max_pan,0)},progress='text',
                   filename=paste0(file.path(dir_arctic),'/stressors/sst/output/pan_sst_icefree_rescaled.tif',sep=""),overwrite=T)

bsr_rescale = crop(pan_rescale,bsr)%>%
                mask(.,bsr,add=T,filename='../seasonal_output/bsr_sst_icefree_rescaled.tif',overwrite=T)

plot(bsr_rescale,box=F,axes=F,col=cols,main='Bering Strait SST\nIce Free Season')

```
